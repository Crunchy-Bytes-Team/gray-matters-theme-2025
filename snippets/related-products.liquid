{% liquid
  assign related_metafield = product.metafields.module.related_products
  assign related_entries = blank

  if related_metafield != blank
    assign candidate_value = related_metafield.value | default: related_metafield

    if candidate_value != blank and candidate_value.entries != blank
      assign related_entries = candidate_value.entries
    endif

    if related_entries == blank and candidate_value != blank
      assign parsed_candidate = candidate_value | parse_json
      if parsed_candidate == blank
        assign parsed_candidate = candidate_value | json | parse_json
      endif

      if parsed_candidate != blank
        if parsed_candidate.entries != blank
          assign related_entries = parsed_candidate.entries
        elsif parsed_candidate.value != blank and parsed_candidate.value.entries != blank
          assign related_entries = parsed_candidate.value.entries
        else
          assign related_entries = parsed_candidate
        endif
      endif
    endif

    if related_entries == blank
      assign parsed_metafield = related_metafield | json | parse_json
      if parsed_metafield.value != blank and parsed_metafield.value.entries != blank
        assign related_entries = parsed_metafield.value.entries
      elsif parsed_metafield.entries != blank
        assign related_entries = parsed_metafield.entries
      endif
    endif
  endif

  if related_entries != blank
    assign related_entries = related_entries | sort: 'position'
  endif
%}

{% assign current_gid = product.id | prepend: 'gid://shopify/Product/' %}
{% assign shown_gids = '|' %}

<div class=''>
  <h3 class='w-full text-center font-accent font-normal text-xl uppercase mb-6'>You may also like</h3>
  <div class='relative w-full pb-6' data-relprod>
    <!-- Viewport -->
    <div class='overflow-hidden md:overflow-visible w-full' data-viewport>
      <!-- Track (flex on mobile, grid on md+) -->
      <div class='flex w-full transition-transform duration-300 ease-in-out md:grid md:grid-cols-4 md:gap-0' data-track>
        {% assign shown = 0 %}
        {% if related_entries != blank %}
          {% assign limit = related_entries | size %}
          {% for entry in related_entries %}
            {% if shown >= limit %}{% break %}{% endif %}

            {% assign entry_gid = entry.gid | default: '' %}
            {% assign related_product = blank %}

            {% if entry.product %}
              {% assign related_product = entry.product %}
            {% endif %}

            {% if related_product == blank and entry.url != blank %}
              {% assign handle_from_url = entry.url | split: '/products/' | last %}
              {% assign handle_from_url = handle_from_url | split: '?' | first %}
              {% assign handle_from_url = handle_from_url | split: '#' | first %}
              {% assign handle_from_url = handle_from_url | strip %}
              {% if handle_from_url != blank %}
                {% assign related_product = all_products[handle_from_url] %}
              {% endif %}
            {% endif %}

            {% if related_product == blank and entry.handle %}
              {% assign handle_from_entry = entry.handle | strip %}
              {% if handle_from_entry != blank %}
                {% assign related_product = all_products[handle_from_entry] %}
              {% endif %}
            {% endif %}

            {% if related_product and related_product != blank %}
              {% assign related_product_gid = related_product.id | prepend: 'gid://shopify/Product/' %}

              {% if related_product_gid == current_gid %}
                {% continue %}
              {% endif %}

              {% if entry_gid != '' and entry_gid != related_product_gid %}
                {% continue %}
              {% endif %}

              {% assign related_gid_token = '|' | append: related_product_gid | append: '|' %}
              {% if shown_gids contains related_gid_token %}
                {% continue %}
              {% endif %}

              <div class='relative group basis-1/2 md:basis-auto shrink-0' data-item>
                <a href='{{ related_product.url }}'>
                  {% if related_product.featured_image %}
                    <img
                      src='{{ related_product.featured_image | image_url: width: 1200 }}'
                      alt='{{ related_product.title | escape }}'
                      loading='lazy'
                    >
                  {% endif %}
                  <div
                    class='absolute inset-0 bg-black opacity-0 group-hover:opacity-30 transition-opacity duration-300 ease-in-out'
                  ></div>
                </a>
              </div>

              {% assign shown = shown | plus: 1 %}
              {% assign shown_gids = shown_gids | append: related_gid_token %}
            {% endif %}
          {% endfor %}
        {% endif %}
      </div>
    </div>

    <!-- Controls (mobile only) -->
    <button
      type='button'
      class='md:hidden absolute left-2 top-1/2 -translate-y-1/2 bg-black/70 text-white rounded-full w-9 h-9 flex items-center justify-center'
      aria-label='Previous'
      data-prev
    >
      ‹
    </button>
    <button
      type='button'
      class='md:hidden absolute right-2 top-1/2 -translate-y-1/2 bg-black/70 text-white rounded-full w-9 h-9 flex items-center justify-center'
      aria-label='Next'
      data-next
    >
      ›
    </button>

    <!-- Progress bar (100px, light gray) appears only during interaction on mobile, on hover on desktop) -->
    <div
      class='absolute left-2 -bottom-3 h-[2px] w-[100px] bg-gray-300 opacity-0 transition-opacity duration-200'
      data-progress
    ></div>
  </div>
</div>
