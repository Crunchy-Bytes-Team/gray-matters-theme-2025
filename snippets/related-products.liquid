<div class='px-4 py-10'>
  <h3 class='w-full text-center font-accent font-normal text-xl uppercase mb-6 lg:mb-10'>You may also like</h3>
  {% comment %} Related products by handles (list of strings) {% endcomment %}
  {% assign related_handles = product.metafields.module.related_product_ids.value %}
  {% comment %} Debug: remove after verifying output {% endcomment %}
  {%- comment -%}{{ product.metafields.module.related_product_ids | json }}{%- endcomment -%}
  <div class='relative w-full pb-6' data-relprod>
    <!-- Viewport -->
    <div class='overflow-hidden md:overflow-visible w-full' data-viewport>
      <!-- Track (flex on mobile, grid on md+) -->
      <div class='flex w-full transition-transform duration-300 ease-in-out md:grid md:grid-cols-4 md:gap-0' data-track>
        {% assign shown = 0 %}
        {% if related_handles and related_handles != blank %}
          {% for handle in related_handles %}
            {% if shown >= 4 %}{% break %}{% endif %}
            {% assign handle_clean = handle | to_s | strip %}
            {% assign p = all_products[handle_clean] %}
            {% if p %}
              <div class='relative group basis-1/2 md:basis-auto shrink-0' data-item>
                <a href='{{ p.url }}'>
                  {% if p.featured_image %}
                    <img
                      src='{{ p.featured_image | image_url: width: 1200 }}'
                      alt='{{ p.title | escape }}'
                      loading='lazy'
                    >
                  {% endif %}
                  <div
                    class='absolute inset-0 bg-black opacity-0 group-hover:opacity-30 transition-opacity duration-300 ease-in-out'
                  ></div>
                </a>
              </div>
              {% assign shown = shown | plus: 1 %}
            {% endif %}
          {% endfor %}
        {% endif %}
      </div>
    </div>

    <!-- Controls (mobile only) -->
    <button
      type='button'
      class='md:hidden absolute left-2 top-1/2 -translate-y-1/2 bg-black/70 text-white rounded-full w-9 h-9 flex items-center justify-center'
      aria-label='Previous'
      data-prev
    >
      ‹
    </button>
    <button
      type='button'
      class='md:hidden absolute right-2 top-1/2 -translate-y-1/2 bg-black/70 text-white rounded-full w-9 h-9 flex items-center justify-center'
      aria-label='Next'
      data-next
    >
      ›
    </button>

    <!-- Progress bar (100px, light gray) appears only during interaction on mobile, on hover on desktop) -->
    <div
      class='absolute left-2 -bottom-3 h-[2px] w-[100px] bg-gray-300 opacity-0 transition-opacity duration-200'
      data-progress
    ></div>
  </div>
</div>
